<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeCheck - Restaurant Vibe Discovery</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            background-color: #0d0d0d;
            font-family: "Roboto", sans-serif;
            color: white;
        }

        /* Hero gradient */
        .hero-gradient {
            background: linear-gradient(135deg, #ffdd55 0%, #ff66aa 100%);
            color: black;
        }

        /* Dark card sections */
        .dark-card {
            background: linear-gradient(180deg, #1a1a1a, #111111);
            border: 1px solid #262626;
        }

        /* Pink section title */
        .pink-title {
            color: #ff66aa;
            font-weight: 900;
            font-size: 2.3rem;
        }

        /* Gradient border ring (yellow ‚Üí pink) */
        .gradient-border {
            border: 2px solid transparent;
            border-radius: 12px;
            background:
                linear-gradient(#1c1c1c, #1c1c1c) padding-box,
                linear-gradient(135deg, #ffdd55, #ff66aa) border-box;
        }

        .gradient-border:hover {
            box-shadow: 0 0 10px rgba(255, 153, 102, 0.4);
        }

        /* Text + upload inside background */
        .input-dark {
            background-color: #1c1c1c;
            color: white;
        }

        /* Search button gradient (matching hero) */
        .search-gradient {
            background: linear-gradient(135deg, #ffdd55 0%, #ff66aa 100%);
            color: black;
            font-size: 1.3rem;
            font-weight: 700;
            padding-top: 1rem;
            padding-bottom: 1rem;
            border-radius: 10px;
            transition: 0.2s ease;
        }

        .search-gradient:hover {
            filter: brightness(1.07);
            box-shadow: 0 0 15px rgba(255, 102, 170, 0.45);
        }

        .label-glow {
            text-shadow: 0 0 6px rgba(255, 102, 170, 0.25);
        }

    </style>
</head>

<body>

    <!-- Header -->
    <header class="hero-gradient text-black shadow-lg">
        <div class="container mx-auto px-6 py-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-5xl font-bold mb-2">VibeCheck</h1>
                    <p class="text-xl opacity-90">Discover restaurants by their atmosphere and vibe!</p>
                </div>
                <img src="{{ url_for('static', filename='vibecheck_logo.png') }}" alt="VibeCheck Logo" class="h-24 md:h-32 object-contain">
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">

        <!-- Search Section -->
        <section class="dark-card rounded-2xl shadow-lg p-8 mb-8">

            <h2 class="pink-title mb-6">What's the vibe?</h2>

            <div class="grid md:grid-cols-2 gap-6">

                <!-- Text Search -->
                <div>
                    <label class="block text-md font-medium text-gray-200 mb-2 label-glow" style="font-size: 1.05rem;">
                        Describe your desired vibe
                    </label>

                    <textarea
                        id="queryText"
                        rows="4"
                        class="w-full px-4 py-3 rounded-lg input-dark"
                        style="border: 2px solid #ffdd55;"
                        placeholder="e.g., cozy cafe with dim lighting and plants, romantic date night spot ..."
                    ></textarea>

                </div>

                <!-- Image Upload -->
                <div>
                    <label class="block text-md font-medium text-gray-200 mb-2 label-glow" style="font-size: 1.05rem;">
                        Or upload an inspiration image
                    </label>

                    <div class="p-6 text-center cursor-pointer"
                        style="border: 2px solid #ff66aa; border-radius: 12px; background-color:#1c1c1c;">

                        <input type="file" id="queryImage" accept="image/*" class="hidden" onchange="previewImage(event)" />

                        <label for="queryImage" class="cursor-pointer block">
                            <div id="imagePreview" class="mb-4"></div>

                            <p class="text-gray-300">Click to upload or drag and drop</p>
                            <p class="text-sm text-gray-500">PNG, JPG up to 16MB</p>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Search Button -->
            <div class="mt-6 flex gap-4">

                <button onclick="searchRestaurants()" class="flex-1 search-gradient">
                    Search Restaurants
                </button>

                <button onclick="clearSearch()" class="px-6 py-3 border-2 border-gray-400 rounded-lg font-semibold hover:bg-gray-800 transition">
                    Clear
                </button>

            </div>
        </section>

        <!-- Results Section -->
        <section id="resultsSection" class="hidden">
            <h2 class="text-3xl font-bold mb-6">Top Matches</h2>
            <div id="results" class="grid md:grid-cols-3 gap-6 mb-8"></div>
        </section>

        <!-- Restaurant Details Modal -->
<!-- Replace your restaurantModal div with this: -->
        <div id="restaurantModal" class="hidden fixed inset-0 flex items-center justify-center p-4" style="z-index: 9999; background-color: rgba(0, 0, 0, 0.85);">
            <div class="dark-card rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto" style="position: relative; z-index: 10000;">
                <div class="sticky top-0 bg-gradient-to-r from-gray-900 to-gray-800 p-4 flex justify-between items-center border-b border-gray-700">
                    <h2 id="modalTitle" class="text-2xl font-bold"></h2>
                    <button onclick="closeModal()" class="text-3xl hover:text-pink-400 transition">&times;</button>
                </div>
                <div id="modalContent" class="p-6"></div>
            </div>
        </div>

        <!-- Vibe Restaurants Modal -->
        <!-- Replace your vibeModal div with this: -->
        <div id="vibeModal" class="hidden fixed inset-0 flex items-center justify-center p-4" style="z-index: 9999; background-color: rgba(0, 0, 0, 0.85);">
            <div class="dark-card rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto" style="position: relative; z-index: 10000;">
                <div class="sticky top-0 bg-gradient-to-r from-gray-900 to-gray-800 p-4 flex justify-between items-center border-b border-gray-700">
                    <h2 id="vibeModalTitle" class="text-2xl font-bold"></h2>
                    <button onclick="closeVibeModal()" class="text-3xl hover:text-pink-400 transition">&times;</button>
                </div>
                <div id="vibeModalContent" class="p-6"></div>
            </div>
        </div>

        <!-- Visualizations -->
        <section class="grid md:grid-cols-2 gap-8 mb-8">

            <div class="dark-card rounded-2xl shadow-lg p-6">
                <h3 class="text-2xl font-bold mb-4">DC Restaurant Map</h3>
                <div id="map" style="height: 500px;"></div>
            </div>

            <div class="dark-card rounded-2xl shadow-lg p-6">
                <h3 class="text-2xl font-bold mb-4">Vibe Space</h3>
                <div id="umap-plot" style="height: 500px;"></div>
            </div>

        </section>

        <section class="dark-card rounded-2xl shadow-lg p-8">
            <h3 class="text-2xl font-bold mb-6">Top Vibes in DC</h3>
            <div id="vibeStats" class="grid md:grid-cols-5 gap-4"></div>
        </section>

    </main>

    <!-- Leaflet CSS and JS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Plotly for UMAP visualization -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <script>
        // Global variables
        let map;
        let markers = [];
        let allRestaurants = [];

        // Initialize map and load data on page load
        window.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadMapData();
            loadVibeStats();
        });

        // Initialize Leaflet map
        function initMap() {
            map = L.map('map').setView([38.9072, -77.0369], 12); // DC coordinates

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18
            }).addTo(map);
        }

        // Load all restaurants for map
        async function loadMapData() {
            try {
                const response = await fetch('/api/map-data');
                const data = await response.json();
                allRestaurants = data.restaurants;

                displayRestaurantsOnMap(allRestaurants);
                displayUMAPPlot(allRestaurants);
            } catch (error) {
                console.error('Error loading map data:', error);
            }
        }

        // Display restaurants on map
        function displayRestaurantsOnMap(restaurants) {
            // Clear existing markers
            restaurantMarkers.forEach(marker => map.removeLayer(marker));
            restaurantMarkers = [];

            restaurants.forEach((restaurant, idx) => {
                // Only display if we have coordinates
                if (restaurant.latitude && restaurant.longitude) {
                    const lat = restaurant.latitude;
                    const lng = restaurant.longitude;

                    const marker = L.marker([lat, lng]).addTo(map);
                    marker.bindPopup(`
                        <div class="p-2">
                            <h4 class="font-bold">${restaurant.name}</h4>
                            <p>‚≠ê ${restaurant.rating || 'N/A'}</p>
                            <p class="text-sm text-gray-600">${restaurant.address || ''}</p>
                        </div>
                    `);

                    // Store restaurant data with marker
                    marker.restaurantId = restaurant.id;
                    marker.defaultIcon = marker._icon;

                    restaurantMarkers.push(marker);
                }
            });
        }

        // Display UMAP plot
        function displayUMAPPlot(restaurants) {
            const validRestaurants = restaurants.filter(r => r.x && r.y);

            // Create hover text with restaurant name, rating, and top vibe
            const hoverText = validRestaurants.map(r =>
                `<b>${r.name}</b><br>` +
                `‚≠ê ${r.rating || 'N/A'} (${r.reviews_count || 0} reviews)<br>` +
                `Top Vibe: ${r.top_vibe || 'Unknown'}<br>` +
                `<i>Click to view details</i>`
            );

            // Store restaurant IDs for click events
            const restaurantIds = validRestaurants.map(r => r.id);

            const trace = {
                x: validRestaurants.map(r => r.x),
                y: validRestaurants.map(r => r.y),
                mode: 'markers',
                type: 'scatter',
                text: hoverText,
                customdata: restaurantIds,
                marker: {
                    size: 10,
                    color: validRestaurants.map(r => r.cluster || 0),
                    colorscale: [
                        [0, '#ffdd55'],      // Yellow
                        [0.33, '#ffaa33'],   // Orange
                        [0.66, '#ff66aa'],   // Pink
                        [1, '#ff3366']       // Red
                    ],
                    showscale: true,
                    colorbar: {
                        title: 'Vibe<br>Cluster',
                        titleside: 'right',
                        tickmode: 'linear',
                        tick0: 0,
                        dtick: 1,
                        font: { color: 'white' }
                    },
                    line: {
                        color: 'rgba(255, 255, 255, 0.3)',
                        width: 1
                    }
                },
                hovertemplate: '%{text}<extra></extra>'
            };

            const layout = {
                title: {
                    text: '<sub>Each point is a restaurant. <br> Closer points = similar vibes. Color = vibe cluster.</sub>',
                    font: { color: '#ff66aa', size: 16 }
                },
                paper_bgcolor: '#1a1a1a',
                plot_bgcolor: '#1a1a1a',
                font: { color: 'white' },
                xaxis: {
                    title: 'Vibe Dimension 1',
                    gridcolor: '#333',
                    showgrid: true,
                    zeroline: false
                },
                yaxis: {
                    title: 'Vibe Dimension 2',
                    gridcolor: '#333',
                    showgrid: true,
                    zeroline: false
                },
                hovermode: 'closest',
                margin: { t: 80, b: 60, l: 60, r: 100 }
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['lasso2d', 'select2d']
            };

            Plotly.newPlot('umap-plot', [trace], layout, config);

            // Add click event to open restaurant details
            document.getElementById('umap-plot').on('plotly_click', function(data) {
                const point = data.points[0];
                const restaurantId = point.customdata;
                if (restaurantId) {
                    showRestaurantDetails(restaurantId);
                }
            });
        }

        // Load vibe statistics
        async function loadVibeStats() {
            try {
                const response = await fetch('/api/vibe-stats');
                const data = await response.json();

                const container = document.getElementById('vibeStats');
                container.innerHTML = data.vibes.map(vibe => `
                    <div class="gradient-border p-4 text-center cursor-pointer hover:scale-105 transition-transform"
                         onclick="showVibeRestaurants('${vibe.name.replace(/'/g, "\\'")}')">
                        <div class="text-2xl font-bold" style="color: #ffdd55;">${vibe.count}</div>
                        <div class="text-sm text-gray-300 mt-1">${vibe.name}</div>
                        <div class="text-xs mt-2" style="color: #ff66aa;">Click to explore ‚Üí</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading vibe stats:', error);
            }
        }

        // Preview uploaded image
        function previewImage(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('imagePreview');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" class="max-w-full h-32 object-cover rounded-lg mx-auto" />`;
                };
                reader.readAsDataURL(file);
            }
        }

        // Search restaurants
        async function searchRestaurants() {
            const queryText = document.getElementById('queryText').value.trim();
            const queryImage = document.getElementById('queryImage').files[0];

            if (!queryText && !queryImage) {
                alert('Please enter a text query or upload an image!');
                return;
            }

            const formData = new FormData();
            if (queryText) formData.append('text', queryText);
            if (queryImage) formData.append('image', queryImage);
            formData.append('top_k', 9);

            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                displayResults(data.results);
            } catch (error) {
                console.error('Search error:', error);
                alert('An error occurred while searching. Please try again.');
            }
        }

        // Display search results
        function displayResults(results) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContainer = document.getElementById('results');

            if (!results || results.length === 0) {
                resultsContainer.innerHTML = '<p class="text-gray-400">No results found.</p>';
                resultsSection.classList.remove('hidden');
                return;
            }

            resultsContainer.innerHTML = results.map(restaurant => `
                <div class="gradient-border p-6 hover:scale-105 transition-transform cursor-pointer" onclick="showRestaurantDetails(${restaurant.id})">
                    ${restaurant.photo_filename ?
                        `<img src="/images/${restaurant.photo_filename}"
                             class="w-full h-48 object-cover rounded-lg mb-4"
                             onerror="this.style.display='none'" />` :
                        `<div class="w-full h-48 bg-gray-800 rounded-lg mb-4 flex items-center justify-center">
                            <span class="text-gray-500">No image</span>
                        </div>`}

                    <h3 class="text-xl font-bold mb-2">${restaurant.name}</h3>

                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-yellow-400">‚≠ê ${restaurant.rating || 'N/A'}</span>
                        <span class="text-gray-400 text-sm">(${restaurant.reviews_count || 0} reviews)</span>
                    </div>

                    <p class="text-sm text-gray-400 mb-3">${restaurant.address || ''}</p>

                    ${restaurant.vibes && restaurant.vibes.length > 0 ? `
                        <div class="flex flex-wrap gap-2 mb-3">
                            ${restaurant.vibes.map(vibe =>
                                `<span class="px-2 py-1 text-xs rounded"
                                      style="background-color: #ff66aa; color: black;">
                                    ${vibe.name} (${vibe.count})
                                </span>`
                            ).join('')}
                        </div>
                    ` : ''}

                    ${restaurant.reviews && restaurant.reviews.length > 0 ? `
                        <div class="mt-3 text-sm text-gray-300 italic">
                            "${restaurant.reviews[0].text}"
                        </div>
                    ` : ''}

                    <div class="mt-2 text-xs text-gray-500">
                        Similarity: ${(restaurant.similarity_score || 0).toFixed(3)}
                    </div>

                    <div class="mt-4 text-center text-sm" style="color: #ff66aa;">
                        Click to view all photos & reviews ‚Üí
                    </div>
                </div>
            `).join('');

            resultsSection.classList.remove('hidden');
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Show restaurant details modal
        async function showRestaurantDetails(restaurantId) {
            try {
                const response = await fetch(`/api/restaurant/${restaurantId}`);
                const restaurant = await response.json();

                if (restaurant.error) {
                    alert('Error loading restaurant details');
                    return;
                }

                document.getElementById('modalTitle').textContent = restaurant.name;

                const modalContent = document.getElementById('modalContent');
                modalContent.innerHTML = `
                    <div class="mb-6">
                        <div class="flex items-center gap-3 mb-3">
                            <span class="text-2xl text-yellow-400">‚≠ê ${restaurant.rating || 'N/A'}</span>
                            <span class="text-gray-400">(${restaurant.reviews_count || 0} reviews)</span>
                        </div>
                        <p class="text-gray-300">${restaurant.address || ''}</p>
                    </div>

                    ${restaurant.vibes && restaurant.vibes.length > 0 ? `
                        <div class="mb-6">
                            <h3 class="text-xl font-bold mb-3" style="color: #ff66aa;">Top Vibes</h3>
                            <div class="flex flex-wrap gap-2">
                                ${restaurant.vibes.map(vibe =>
                                    `<span class="px-3 py-2 text-sm rounded"
                                          style="background-color: #ff66aa; color: black;">
                                        ${vibe.name} (${vibe.count} mentions)
                                    </span>`
                                ).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${restaurant.photos && restaurant.photos.length > 0 ? `
                        <div class="mb-6">
                            <h3 class="text-xl font-bold mb-3" style="color: #ffdd55;">Vibe Photos (${restaurant.photos.length})</h3>
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                                ${restaurant.photos.map((photo, index) =>
                                    `<div class="relative">
                                        <div class="absolute top-2 left-2 bg-black bg-opacity-75 text-white text-xs px-2 py-1 rounded">
                                            #${index + 1}
                                        </div>
                                        <img src="/images/${photo.filename}"
                                             class="w-full h-32 object-cover rounded-lg"
                                             onerror="this.style.display='none'" />
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${restaurant.reviews && restaurant.reviews.length > 0 ? `
                        <div class="mb-6">
                            <h3 class="text-xl font-bold mb-3" style="color: #ffdd55;">Top ${restaurant.reviews.length} Reviews</h3>
                            <div class="space-y-4">
                                ${restaurant.reviews.map((review, index) =>
                                    `<div class="bg-gray-800 p-4 rounded-lg">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-sm font-bold" style="color: #ff66aa;">Review #${index + 1}</span>
                                            <span class="text-sm text-gray-500">üëç ${review.likes} likes</span>
                                        </div>
                                        <p class="text-gray-300">"${review.text}"</p>
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${restaurant.latitude && restaurant.longitude ? `
                        <div>
                            <h3 class="text-xl font-bold mb-3" style="color: #ffdd55;">Location</h3>
                            <div id="restaurantMap" style="height: 300px; border-radius: 12px;"></div>
                        </div>
                    ` : ''}
                `;

                document.getElementById('restaurantModal').classList.remove('hidden');

                // Initialize map if coordinates are available
                if (restaurant.latitude && restaurant.longitude) {
                    setTimeout(() => {
                        const restaurantMap = L.map('restaurantMap').setView([restaurant.latitude, restaurant.longitude], 15);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; OpenStreetMap contributors'
                        }).addTo(restaurantMap);
                        L.marker([restaurant.latitude, restaurant.longitude]).addTo(restaurantMap)
                            .bindPopup(`<b>${restaurant.name}</b><br>${restaurant.address}`).openPopup();
                    }, 100);
                }
            } catch (error) {
                console.error('Error loading restaurant details:', error);
                alert('Error loading restaurant details');
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('restaurantModal').classList.add('hidden');
        }

        // Show restaurants by vibe
        async function showVibeRestaurants(vibeName) {
            try {
                const response = await fetch(`/api/restaurants-by-vibe?vibe=${encodeURIComponent(vibeName)}`);
                const data = await response.json();

                if (data.error || !data.restaurants) {
                    alert('Failed to load restaurants for this vibe');
                    return;
                }

                document.getElementById('vibeModalTitle').textContent = `${vibeName} Restaurants (${data.restaurants.length})`;

                const vibeModalContent = document.getElementById('vibeModalContent');
                vibeModalContent.innerHTML = `
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${data.restaurants.map((restaurant, index) => `
                            <div class="gradient-border p-4 cursor-pointer hover:scale-105 transition-transform"
                                 onclick="closeVibeModal(); showRestaurantDetails(${restaurant.id});">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-2xl font-bold" style="color: #ffdd55;">#${index + 1}</span>
                                    <span class="text-sm" style="color: #ff66aa;">${restaurant.mention_count} mentions</span>
                                </div>

                                ${restaurant.photo_filename ? `
                                    <img src="/images/${restaurant.photo_filename}"
                                         class="w-full h-32 object-cover rounded-lg mb-3"
                                         onerror="this.style.display='none'" />
                                ` : ''}

                                <h4 class="font-bold text-lg mb-2">${restaurant.name}</h4>

                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-yellow-400">‚≠ê ${restaurant.rating || 'N/A'}</span>
                                    <span class="text-gray-400 text-sm">(${restaurant.reviews_count || 0} reviews)</span>
                                </div>

                                <p class="text-sm text-gray-400 mb-3">${restaurant.address || ''}</p>

                                ${restaurant.top_review ? `
                                    <p class="text-xs text-gray-300 italic mb-2">"${restaurant.top_review}"</p>
                                ` : ''}

                                <div class="text-xs text-center mt-3" style="color: #ff66aa;">
                                    Click for full details ‚Üí
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

                document.getElementById('vibeModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading vibe restaurants:', error);
                alert('Error loading restaurants for this vibe');
            }
        }

        // Close vibe modal
        function closeVibeModal() {
            document.getElementById('vibeModal').classList.add('hidden');
        }

        // Clear search
        function clearSearch() {
            document.getElementById('queryText').value = '';
            document.getElementById('queryImage').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('resultsSection').classList.add('hidden');
        }

        // Initialize restaurant markers array
        let restaurantMarkers = [];

        // Close modal when clicking outside
        document.getElementById('restaurantModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('vibeModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeVibeModal();
            }
        });
    </script>
</body>
</html>
