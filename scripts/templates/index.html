<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeCheck - Restaurant Vibe Discovery</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        .hero-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        #map {
            height: 500px;
            border-radius: 1rem;
        }
        
        #umap-plot {
            height: 500px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- Header -->
    <header class="hero-gradient text-white shadow-lg">
        <div class="container mx-auto px-6 py-8">
            <h1 class="text-5xl font-bold mb-2">üçΩÔ∏è VibeCheck</h1>
            <p class="text-xl opacity-90">Discover restaurants by their atmosphere and vibe</p>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        
        <!-- Search Section -->
        <section class="bg-white rounded-2xl shadow-lg p-8 mb-8">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">Find Your Perfect Vibe</h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Text Search -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Describe your desired vibe
                    </label>
                    <textarea 
                        id="queryText" 
                        rows="4"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        placeholder="e.g., cozy cafe with dim lighting and plants, romantic date night spot, lively outdoor patio..."
                    ></textarea>
                </div>
                
                <!-- Image Upload -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Or upload an inspiration image
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-purple-500 transition cursor-pointer">
                        <input 
                            type="file" 
                            id="queryImage" 
                            accept="image/*"
                            class="hidden"
                            onchange="previewImage(event)"
                        />
                        <label for="queryImage" class="cursor-pointer">
                            <div id="imagePreview" class="mb-4"></div>
                            <div class="text-gray-600">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <p class="mt-2">Click to upload or drag and drop</p>
                                <p class="text-sm text-gray-500">PNG, JPG up to 16MB</p>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Search Button -->
            <div class="mt-6 flex gap-4">
                <button 
                    onclick="searchRestaurants()"
                    class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-8 py-4 rounded-lg font-semibold text-lg hover:from-purple-700 hover:to-indigo-700 transition shadow-lg hover:shadow-xl"
                >
                    <span id="searchButtonText">üîç Search Restaurants</span>
                    <span id="searchButtonLoading" class="hidden">
                        <span class="loading"></span> Searching...
                    </span>
                </button>
                <button 
                    onclick="clearSearch()"
                    class="px-6 py-4 border-2 border-gray-300 rounded-lg font-semibold hover:bg-gray-50 transition"
                >
                    Clear
                </button>
            </div>
        </section>
        
        <!-- Results Section -->
        <section id="resultsSection" class="hidden">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">Top Matches</h2>
            <div id="results" class="grid md:grid-cols-3 gap-6 mb-8"></div>
        </section>
        
        <!-- Visualizations -->
        <section class="grid md:grid-cols-2 gap-8 mb-8">
            <!-- Geographic Map -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">üìç DC Restaurant Map</h3>
                <div id="map"></div>
            </div>
            
            <!-- UMAP Visualization -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">üé® Vibe Space</h3>
                <div id="umap-plot"></div>
            </div>
        </section>
        
        <!-- Vibe Stats -->
        <section class="bg-white rounded-2xl shadow-lg p-8">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">‚ú® Top Vibes in DC</h3>
            <div id="vibeStats" class="grid md:grid-cols-5 gap-4"></div>
        </section>
        
    </main>
    
    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto px-6 text-center">
            <p>Made with ‚ù§Ô∏è using Flask, CLIP, and Sentence Transformers</p>
        </div>
    </footer>
    
    <script>
        let map;
        let restaurantMarkers = [];
        let allRestaurantData = [];
        let umapPlotDiv = null;
        
        // Initialize map
        function initMap() {
            // DC coordinates
            map = L.map('map').setView([38.9072, -77.0369], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Load restaurant data
            loadMapData();
        }
        
        // Load map data
        async function loadMapData() {
            try {
                const response = await fetch('/api/map-data');
                const data = await response.json();
                allRestaurantData = data.restaurants;
                
                // For now, place markers at DC locations (you'll need to geocode addresses)
                // This is a placeholder - you'd need actual lat/lng coordinates
                data.restaurants.forEach((restaurant, idx) => {
                    // Random positions around DC for demo
                    const lat = 38.9072 + (Math.random() - 0.5) * 0.1;
                    const lng = -77.0369 + (Math.random() - 0.5) * 0.1;
                    
                    const marker = L.marker([lat, lng]).addTo(map);
                    marker.bindPopup(`
                        <div class="p-2">
                            <h4 class="font-bold">${restaurant.name}</h4>
                            <p>‚≠ê ${restaurant.rating || 'N/A'}</p>
                            <p class="text-sm text-gray-600">${restaurant.address || ''}</p>
                        </div>
                    `);
                    
                    // Store restaurant data with marker
                    marker.restaurantId = restaurant.id;
                    marker.defaultIcon = marker._icon;
                    
                    restaurantMarkers.push(marker);
                });
            } catch (error) {
                console.error('Error loading map data:', error);
            }
        }
        
        // Update maps with search results
        function updateMapsWithResults(results) {
            const resultIds = new Set(results.map(r => r.id));
            
            // Update geographic map markers
            restaurantMarkers.forEach(marker => {
                const isResult = resultIds.has(marker.restaurantId);
                
                if (isResult) {
                    // Highlight matched restaurants
                    marker.setIcon(L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    }));
                    marker.setOpacity(1);
                    marker.setZIndexOffset(1000);
                } else {
                    // Fade non-matched restaurants
                    marker.setIcon(L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    }));
                    marker.setOpacity(0.3);
                    marker.setZIndexOffset(0);
                }
            });
            
            // Update UMAP plot
            updateUMAPWithResults(results);
        }
        
        // Update UMAP plot to highlight results
        function updateUMAPWithResults(results) {
            const resultIds = new Set(results.map(r => r.id));
            const restaurants = allRestaurantData.filter(r => r.x && r.y);
            
            // Separate matched and non-matched restaurants
            const matched = restaurants.filter(r => resultIds.has(r.id));
            const nonMatched = restaurants.filter(r => !resultIds.has(r.id));
            
            // Non-matched trace (faded)
            const trace1 = {
                x: nonMatched.map(r => r.x),
                y: nonMatched.map(r => r.y),
                mode: 'markers',
                type: 'scatter',
                name: 'Other Restaurants',
                text: nonMatched.map(r => r.name),
                marker: {
                    size: 6,
                    color: 'lightgray',
                    opacity: 0.3
                },
                hovertemplate: '<b>%{text}</b><extra></extra>'
            };
            
            // Matched trace (highlighted)
            const trace2 = {
                x: matched.map(r => r.x),
                y: matched.map(r => r.y),
                mode: 'markers',
                type: 'scatter',
                name: 'Search Results',
                text: matched.map(r => r.name),
                marker: {
                    size: matched.map((r, i) => 20 - i * 1.5), // Size by rank
                    color: '#ef4444',
                    symbol: 'star',
                    line: {
                        color: 'white',
                        width: 2
                    }
                },
                hovertemplate: '<b>%{text}</b><br>Match!<extra></extra>'
            };
            
            const layout = {
                xaxis: { title: 'UMAP 1', showgrid: false },
                yaxis: { title: 'UMAP 2', showgrid: false },
                hovermode: 'closest',
                plot_bgcolor: '#f9fafb',
                paper_bgcolor: 'white',
                showlegend: true,
                legend: {
                    x: 1.02,
                    y: 1
                }
            };
            
            Plotly.newPlot('umap-plot', [trace1, trace2], layout, {responsive: true});
        }
        
        // Load UMAP visualization
        async function loadUMAPPlot() {
            try {
                const response = await fetch('/api/map-data');
                const data = await response.json();
                allRestaurantData = data.restaurants;
                
                const restaurants = data.restaurants.filter(r => r.x && r.y);
                
                const trace = {
                    x: restaurants.map(r => r.x),
                    y: restaurants.map(r => r.y),
                    mode: 'markers',
                    type: 'scatter',
                    text: restaurants.map(r => r.name),
                    marker: {
                        size: restaurants.map(r => (r.rating || 3) * 2),
                        color: restaurants.map(r => r.cluster || 0),
                        colorscale: 'Viridis',
                        showscale: true,
                        colorbar: {
                            title: 'Cluster'
                        }
                    },
                    hovertemplate: '<b>%{text}</b><br>Rating: %{marker.size}<extra></extra>'
                };
                
                const layout = {
                    xaxis: { title: 'UMAP 1', showgrid: false },
                    yaxis: { title: 'UMAP 2', showgrid: false },
                    hovermode: 'closest',
                    plot_bgcolor: '#f9fafb',
                    paper_bgcolor: 'white'
                };
                
                Plotly.newPlot('umap-plot', [trace], layout, {responsive: true});
            } catch (error) {
                console.error('Error loading UMAP plot:', error);
            }
        }
        
        // Load vibe statistics
        async function loadVibeStats() {
            try {
                const response = await fetch('/api/vibe-stats');
                const data = await response.json();
                
                const container = document.getElementById('vibeStats');
                container.innerHTML = data.vibes.map(vibe => `
                    <div class="bg-gradient-to-br from-purple-100 to-indigo-100 p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold text-purple-600">${vibe.count}</p>
                        <p class="text-sm text-gray-700">${vibe.name}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading vibe stats:', error);
            }
        }
        
        // Preview uploaded image
        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagePreview').innerHTML = `
                        <img src="${e.target.result}" class="image-preview mx-auto" />
                    `;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Search restaurants
        async function searchRestaurants() {
            const text = document.getElementById('queryText').value;
            const imageFile = document.getElementById('queryImage').files[0];
            
            if (!text && !imageFile) {
                alert('Please enter text or upload an image!');
                return;
            }
            
            // Show loading
            document.getElementById('searchButtonText').classList.add('hidden');
            document.getElementById('searchButtonLoading').classList.remove('hidden');
            
            try {
                const formData = new FormData();
                formData.append('text', text);
                if (imageFile) {
                    formData.append('image', imageFile);
                }
                formData.append('top_k', 9);
                
                const response = await fetch('/api/search', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                displayResults(data.results);
            } catch (error) {
                console.error('Search error:', error);
                alert('Search failed. Please try again.');
            } finally {
                // Hide loading
                document.getElementById('searchButtonText').classList.remove('hidden');
                document.getElementById('searchButtonLoading').classList.add('hidden');
            }
        }
        
        // Display search results
        function displayResults(results) {
            const container = document.getElementById('results');
            const section = document.getElementById('resultsSection');
            
            section.classList.remove('hidden');
            
            container.innerHTML = results.map(restaurant => `
                <div class="bg-white rounded-xl shadow-md overflow-hidden card-hover">
                    ${restaurant.photo_filename ? 
                        `<img src="/images/${restaurant.photo_filename}" class="w-full h-48 object-cover" />` :
                        `<div class="w-full h-48 bg-gradient-to-br from-purple-200 to-indigo-200 flex items-center justify-center">
                            <span class="text-4xl">üçΩÔ∏è</span>
                        </div>`
                    }
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-2 text-gray-800">${restaurant.name}</h3>
                        <div class="flex items-center mb-3">
                            <span class="text-yellow-500">‚≠ê ${restaurant.rating || 'N/A'}</span>
                            <span class="text-gray-500 text-sm ml-2">(${restaurant.reviews_count || 0} reviews)</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">üìç ${restaurant.address || 'Address not available'}</p>
                        ${restaurant.vibes.length > 0 ? `
                            <div class="flex flex-wrap gap-2 mb-3">
                                ${restaurant.vibes.map(vibe => `
                                    <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full">
                                        ${vibe.name}
                                    </span>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${restaurant.reviews.length > 0 ? `
                            <p class="text-sm text-gray-700 italic">"${restaurant.reviews[0].text}"</p>
                        ` : ''}
                    </div>
                </div>
            `).join('');
            
            // Update maps with search results
            updateMapsWithResults(results);
            
            // Scroll to results
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Clear search
        function clearSearch() {
            document.getElementById('queryText').value = '';
            document.getElementById('queryImage').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('resultsSection').classList.add('hidden');
            
            // Reset maps to original state
            resetMaps();
        }
        
        // Reset maps to show all restaurants
        function resetMaps() {
            // Reset geographic markers
            restaurantMarkers.forEach(marker => {
                marker.setIcon(L.icon({
                    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                }));
                marker.setOpacity(1);
                marker.setZIndexOffset(0);
            });
            
            // Reset UMAP plot
            loadUMAPPlot();
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadUMAPPlot();
            loadVibeStats();
        });
    </script>
</body>
</html>